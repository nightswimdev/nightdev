<!DOCTYPE html>
<html>
  <head>
    <script src="../auth.js"></script>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no" />
    <meta http-equiv="Content-Security-Policy" content="
      default-src 'self';
      connect-src 'self' https://math.cinevez.lol https://*.cloudflare.com https://*.pages.dev https://api.ipgeolocation.io https://ipapi.co https://ip-api.com https://*.google-analytics.com https://*.groq.com https://api.ipify.org https://api.ip.sb https://open.spotify.com https://*.spotify.com;
      script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdnjs.cloudflare.com https://*.google-analytics.com;
      style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com;
      img-src 'self' data: https:;
      font-src 'self' https://cdnjs.cloudflare.com;
      frame-src 'self' https:;
      object-src 'none';
    ">
    <title>nightdev | Search</title>
    <link rel="stylesheet" href="index.css" />
    <link rel="icon" type="image/x-icon" href="/assets/js/icon/Untitled design (14)-Picsart-BackgroundRemover.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      }

      body {
        background: linear-gradient(135deg, #1a1a1a, #2d2d2d);
        min-height: 100vh;
        color: white;
      }

      .home-navbar {
        transform: translateX(-50%);
        width: 670px;
        top: 1%;
        margin-bottom: -10px;
        margin-left: 50%;
        background-color: #08080894;
        border: 1px solid #ffffff21;
        height: 35px;
        color: #818181;
        padding: 10px;
        text-align: center;
        font-size: 18px;
        font-weight: bold;
        z-index: 1001;
        backdrop-filter: blur(5px);
        border-radius: 25px;
        position: fixed;
        display: flex;
        justify-content: center;
        align-items: center;
        transition: transform 0.3s ease;
      }

      .home-navbar .favicon {
        width: 24px;
        height: 24px;
        margin-right: -10px;
        vertical-align: middle;
      }

      .home-navbar a {
        color: #7c7c7c;
        text-decoration: none;
        padding: 8px 16px;
        font-size: 14px;
        font-weight: 300;
        border-radius: 5px;
        position: relative;
        transition: all 0.3s ease;
      }

      .home-navbar a:hover {
        color: #bbbbbb;
        font-size: 16px;
      }

      .home-navbar a:active {
        font-size: 12px;
      }

      .home-navbar i {
        color: #ffffff; 
        margin-right: -15px;
        margin-left: 115px;
      }

      .navbar {
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background-color: transparent;
        backdrop-filter: blur(10px);
        border: transparent;
        width: 1100px;
        max-width: 98vw;
        display: block;
        border-radius: 25px;
        align-items: center;
        overflow: hidden;
        position: fixed;
        z-index: 999;
        animation: fadeIn 0.3s ease;
        padding: 0.5em 1em;
      }

      /* Navbar Light Effects */
      .navbar-light-border {
        pointer-events: none;
        position: absolute;
        inset: 0;
        border-radius: 25px; 
        opacity: 0;
        transition: opacity 400ms ease;
        z-index: 1;
        background-image: radial-gradient(circle at center, rgba(211 211 211 / 0.8), rgba(211 211 211 / 0) 60%);
        background-position: var(--navbar-bg-x) var(--navbar-bg-y);
        background-repeat: no-repeat;
        background-size: 300px 300px;
      }

      .navbar-light {
        pointer-events: none;
        position: absolute;
        inset: 0;
        border-radius: 25px; 
        opacity: 0; 
        transition: opacity 400ms ease;
        z-index: 10;
        background-image: radial-gradient(circle at center, rgba(211, 211, 211, 0.13), rgba(211 211 211 / 0) 60%);
        background-position: var(--navbar-bg-x) var(--navbar-bg-y);
        background-repeat: no-repeat;
        background-size: 300px 300px;
      }

      .navbar-light-inset-bg {
        position: absolute;
        inset: 0.8px; 
        border-radius: 24px; 
        background-color: #0e0e0e;
        transition: background-color 0.15s ease;
        z-index: 2;
      }

      .navbar:hover .navbar-light-inset-bg {
        background-color: #161616;
      }

      /* Ensure navbar content stays on top */
      .nav-buttons {
        position: relative;
        z-index: 20;
        list-style: none;
        margin: 0;
        padding: 0;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5em;
      }
      .nav-buttons li {
        display: flex;
        align-items: center;
      }
      .nav-buttons a {
        color: #eceff4;
        text-decoration: none;
        padding: 0.4em 0.7em;
        border-radius: 1em;
        transition: background 0.15s, color 0.15s, font-size 0.15s;
        font-size: 1.1em;
        display: flex;
        align-items: center;
      }
      .nav-buttons a:hover, .nav-buttons a.active {
        background: #c4c4c4b7;
        color: #242424;
        font-size: 1.18em;
      }
      .nav-buttons a.disabled {
        opacity: 0.5;
        pointer-events: none;
      }
      .spin {
    animation: spin 0.15s ease-in-out;
    transform: rotate(720deg);
    transform-origin: center;
}

.small-searchbar {
    display: flex;
    justify-content: center;
    align-items: center;
    width: 700px;
}

.small-searchbar input[type=text] {
    padding: 16px;
    width: 90%;
    background-color: #00000000;
    border: none;
    border-radius: 25px;
    color: #b9b9b9;
    font-size: 15px;
    text-align: left;
    text-indent: 0.5em;
    outline: none;
    transition: all 0.15s ease;
}
 
.small-searchbar input[type=text]:focus,
.small-searchbar input[type=text]:hover {
    background-color: #ffffff0a;
}

.small-searchbar input[type=text]::placeholder {
    color: #818181;
}

.shortcut-indicator,
.shortcut-indicator-2,
.shortcut-indicator-3 {
    font-size: 12px;
    font-weight: 500;
    color: #000000;
    background-color: #c4c4c4;
    padding: 2px 6px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.15s ease;
    animation: fadeIn 0.15s ease;
    position: absolute;
    z-index: 4;
}

.shortcut-indicator {
    top: 50%;
    left: 50%;
    transform: translate(calc(-50% + 230px), -50%);
}

.shortcut-indicator-2 {
    top: 50%;
    left: 50%;
    transform: translate(calc(-50% + 300px), -50%);
}

.shortcut-indicator-3 {
  top: 50%;
  left: 50%;
  transform: translate(calc(-50% + 195px), -50%);
}

.shortcut-indicator:hover,
.shortcut-indicator-2:hover,
.shortcut-indicator-3:hover {
    background-color: #ffffff;
}

.arrow-mode {
   display: inline-block;
   margin-left: 17px;
   transition: all 0.15s ease;
   animation: fadeIn 0.15s ease;
}

.escape-mode {
   margin-left: 17px;
   transition: all 0.15s ease;
   animation: fadeIn 0.15s ease;
}

#lockIcon {
    position: absolute;
    left: 54px;
    top: 50%;
    font-size: 18px;
    transform: translateY(-50%);
    color: #b9b9b9;
}

/* Search Suggestions Styles */
.suggestions-container {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: #1a1a1a;
    border: 1px solid #333;
    border-radius: 12px;
    margin-top: 5px;
    max-height: 300px;
    overflow-y: auto;
    z-index: 1000;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    backdrop-filter: blur(10px);
    display: none;
}

.suggestion-item {
    padding: 12px 16px;
    cursor: pointer;
    border-bottom: 1px solid #2a2a2a;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 12px;
}

.suggestion-item:last-child {
    border-bottom: none;
}

.suggestion-item:hover,
.suggestion-item.selected {
    background: #2a2a2a;
    color: #fff;
}

.suggestion-icon {
    width: 16px;
    height: 16px;
    opacity: 0.7;
    flex-shrink: 0;
}

.suggestion-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.suggestion-title {
    color: #e0e0e0;
    font-size: 14px;
    font-weight: 500;
}

.suggestion-url {
    color: #888;
    font-size: 12px;
    opacity: 0.8;
}

.suggestion-type {
    color: #666;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-left: auto;
    flex-shrink: 0;
}

/* Scrollbar styling for suggestions */
.suggestions-container::-webkit-scrollbar {
    width: 6px;
}

.suggestions-container::-webkit-scrollbar-track {
    background: #1a1a1a;
}

.suggestions-container::-webkit-scrollbar-thumb {
    background: #444;
    border-radius: 3px;
}

.suggestions-container::-webkit-scrollbar-thumb:hover {
    background: #555;
}

.search-container {
    position: relative;
    margin-top: 40vh;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
    width: 90%;
    z-index: 20;
}

.search-title {
    font-size: 60px;
    font-weight: 500;
    text-align: center;
    display: inline-block;
    background: linear-gradient(-45deg, #8d8d8d, #ffffff);
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
    color: transparent;
    cursor: default;
    transition: all 0.15s ease;
}

.search-title span {
    display: inline-block;
    opacity: 0;
    background: inherit;
    color: transparent;
    transform: translateY(4rem);
    animation: fadeSlideIn 0.6s forwards;
}

.search-version {
    font-size: 20px;
    color: #ffffff;
    margin-bottom: -40px;
    margin-right: -255px;
    font-weight: 500;
    transition: all 0.15s ease;
    transform: rotate(33deg);
    animation: fadeUp 0.6s forwards;
}

.search-bar {
    justify-content: center;
    align-items: center;
    z-index: 10;
    margin: 0 auto;
    position: relative;
    width: 577px;
    max-width: 100%;
}

.search-bar input[type=text] {
    padding: 16px 16px 16px 40px;
    z-index: 3;
    width: 550px;
    border-radius: 25px;
    color: #e0e0e0;
    font-size: 15px;
    border: transparent;
    background-color: transparent; 
    text-indent: 0.5em;
    outline: none;
    transition: all 0.15s ease;
    position: relative;
}

.search-bar input[type=text]::placeholder {
    color: #ffffff69;
}
      .iframe-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        z-index: 1;
        background: #222;
      }
      #cool-iframe {
        width: 100vw;
        height: 100vh; /* changed to full viewport to remove bottom gap */
        border: none;
        background: #222;
        display: block;
      }
      @media (max-width: 1000px) {
        .navbar {
          width: 99vw;
          min-width: 0;
          padding: 0.2em 0.2em;
        }
        .small-searchbar {
          min-width: 120px;
          max-width: 180px;
        }
      }

      /* New styles for the navigation controls */
      .nav-controls {
        position: fixed;
        top: 70px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 10px;
        z-index: 1000;
      }

      .nav-controls button {
        background: #333;
        color: #fff;
        border: none;
        padding: 10px 15px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        transition: background 0.3s, transform 0.3s;
      }

      .nav-controls button:hover {
        background: #444;
      }

      .nav-controls button:active {
        transform: scale(0.98);
      }

      /* Loading Line */
      .loading-line {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 3px;
        z-index: 9999;
        background: transparent;
      }

      .loading-line .progress-bar {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, #868686, #ffffff, #666666);
        background-size: 200% 100%;
        animation: loadingProgress 2s ease-in-out, shimmer 1.1s ease-in-out infinite;
        border-radius: 0 3px 3px 0;
        box-shadow: 0 0 10px rgba(99, 102, 241, 0.5);
      }

      @keyframes loadingProgress {
        0% { width: 0%; }
        20% { width: 25%; }
        40% { width: 50%; }
        60% { width: 65%; }
        80% { width: 80%; }
        95% { width: 90%; }
        100% { width: 95%; }
      }

      @keyframes shimmer {
        0% { background-position: -200% 0; }
        100% { background-position: 200% 0; }
      }

      .loading-line.hide {
        opacity: 0;
        transition: opacity 0.3s ease;
      }
    </style>
  </head>
  <body style="background:#000000;">
    <!-- Loading Line -->
    <div id="loadingLine" class="loading-line">
      <div class="progress-bar"></div>
    </div>

    <div class="navbar" style="display: block;" bis_skin_checked="1">
      <div class="navbar-light-border"></div>
      <div class="navbar-light-inset-bg"></div>
      <div class="navbar-light"></div>
    <ul class="nav-buttons">
      <li><a id="backIcon" href="#" class="disabled"><i class="fa-solid fa-arrow-left"></i></a></li>
      <li><a id="refreshIcon" href="#"><i class="fa-solid fa-rotate-right"></i></a></li>
      <li><a id="forwardIcon" href="#" class="disabled"><i class="fa-solid fa-arrow-right"></i></a></li>
      <li>
        <div class="small-searchbar" style="position:relative" bis_skin_checked="1">
          <i id="lockIcon" class="fa-solid fa-lock"></i>
          <input class="waves" type="text" id="searchInputt" placeholder="Search for a query or enter a URL..." autocomplete="off" style="padding-left:40px">
          <span class="shortcut-indicator-2" data-original="Ctrl + E">Ctrl + E</span>
          <div id="suggestions-container" class="suggestions-container"></div>
        </div>
      </li>
      <li><a id="fullscreenIcon" href="#"><i class="fa-solid fa-expand"></i></a></li>
      <li><a href="/index.html"><i class="fa-solid fa-house"></i></a></li>
      <li><a id="erudaIcon" href="#"><i class="fa-solid fa-code"></i></a></li>
    </ul>
  </div>
    <!-- iframe: now full height (no extra space below) -->
    <iframe id="cool-iframe"></iframe>

    <!-- Settings script first -->
    <script src="../settings.js"></script>
    
    <!-- Ultraviolet scripts -->
    <script src="/active/uv/uv.bundle.js"></script>
    <script src="/active/uv/uv.config.js"></script>
    <script src="/active/uv/uv.handler.js"></script>
    
    <!-- Service worker registration -->
    <script src="../assets/js/register.js"></script>
    
    <!-- Search functionality -->
    <script src="search.js"></script>

    <script>
    // Loading line control
    const loadingLine = document.getElementById('loadingLine');
    const progressBar = loadingLine.querySelector('.progress-bar');
    
    // Function to show loading line
    function showLoadingLine() {
      loadingLine.style.display = 'block';
      loadingLine.classList.remove('hide');
      progressBar.style.width = '0%';
      progressBar.style.animation = 'loadingProgress 3s ease-out forwards, shimmer 1.1s ease-in-out infinite';
    }
    
    // Function to hide loading line
    function hideLoadingLine() {
      progressBar.style.width = '100%';
      setTimeout(() => {
        loadingLine.classList.add('hide');
        setTimeout(() => {
          loadingLine.style.display = 'none';
          progressBar.style.animation = '';
        }, 300);
      }, 200);
    }
    
    // Hide loading line when main page is fully loaded
    window.addEventListener('load', () => {
      setTimeout(hideLoadingLine, 500);
    });

    // consolidated script (replaces duplicated/removed blocks)
    document.addEventListener('DOMContentLoaded', async () => {
      const iframe = document.getElementById('cool-iframe');

      function isValidHttpUrl(string) {
        try { const u = new URL(string); return u.protocol === 'http:' || u.protocol === 'https:'; }
        catch { return false; }
      }

      function buildUrl(input) {
        // Normalize input and convert bare domains -> https, treat empty as default search engine homepage
        if (input == null || input.trim() === '') {
          // Get user's preferred search engine, fallback to DuckDuckGo
          const defaultEngine = (typeof window.getSavedSettings === 'function' && window.getSavedSettings().defaultEngine) || 
                               localStorage.getItem('defaultEngine') || 
                               'https://duckduckgo.com';
          return defaultEngine;
        }
        input = decodeURIComponent(input.trim());
        if (/^[\w-]+\.[\w.-]+(?:\/.*)?$/.test(input) && !/^https?:\/\//i.test(input)) {
          input = 'https://' + input;
        }
        if (isValidHttpUrl(input)) return input;
        
        // Use user's preferred search engine for search queries
        const defaultEngine = (typeof window.getSavedSettings === 'function' && window.getSavedSettings().defaultEngine) || 
                             localStorage.getItem('defaultEngine') || 
                             'https://duckduckgo.com';
        
        // Create search URL based on the engine
        if (defaultEngine.includes('google.com')) {
          return 'https://www.google.com/search?q=' + encodeURIComponent(input);
        } else if (defaultEngine.includes('bing.com')) {
          return 'https://www.bing.com/search?q=' + encodeURIComponent(input);
        } else {
          // Default to DuckDuckGo format
          return 'https://duckduckgo.com/?q=' + encodeURIComponent(input);
        }
      }

      const params = new URLSearchParams(window.location.search);
      const userInput = params.get('url');
      const searchTerm = params.get('search'); // Get the original search term
      const finalUrl = buildUrl(userInput);

      // Use the original search term if available, otherwise extract from URL
      let displayTerm = '';
      if (searchTerm) {
        // Use the original search term passed from index.html
        displayTerm = decodeURIComponent(searchTerm);
      } else if (userInput) {
        const decodedInput = decodeURIComponent(userInput.trim());
        
        // Check if it's a DuckDuckGo search URL and extract the search term
        if (decodedInput.includes('duckduckgo.com/?q=')) {
          const searchMatch = decodedInput.match(/[?&]q=([^&]*)/);
          if (searchMatch) {
            displayTerm = decodeURIComponent(searchMatch[1]);
          }
        }
        // If it's a direct URL, show the URL
        else if (decodedInput.startsWith('http')) {
          displayTerm = decodedInput;
        }
        // Otherwise, show the original input
        else {
          displayTerm = decodedInput;
        }
      }

      // always have a default (duckduckgo) instead of aborting
      if (!finalUrl) {
        console.error('No URL provided, falling back to duckduckgo.');
      }

      // wait for Ultraviolet config/encodeUrl to be available
      let tries = 0;
      while ((typeof window.__uv$config === 'undefined' || typeof window.__uv$config.encodeUrl !== 'function') && tries < 50) {
        await new Promise(r => setTimeout(r, 100));
        tries++;
      }

      if (typeof window.__uv$config === 'undefined' || typeof window.__uv$config.encodeUrl !== 'function') {
        console.error('Proxy config not ready. Reload the page.', window.__uv$config);
        // still attempt to load duckduckgo directly if proxy not ready
        iframe.src = 'https://duckduckgo.com';
        return;
      }

      try {
        new URL(finalUrl); // sanity check
        iframe.src = window.__uv$config.prefix + window.__uv$config.encodeUrl(finalUrl);
        // Store the display term (original search) instead of the final URL
        if (displayTerm) {
          localStorage.setItem('lastUvUrl', displayTerm);
        } else {
          localStorage.setItem('lastUvUrl', finalUrl);
        }
      } catch (err) {
        console.error('Invalid URL:', finalUrl, err);
        // fallback to duckduckgo homepage
        try { iframe.src = window.__uv$config.prefix + window.__uv$config.encodeUrl('https://duckduckgo.com'); }
        catch { iframe.src = 'https://duckduckgo.com'; }
      }

      // navbar handlers
      const backBtn = document.getElementById('backIcon');
      const forwardBtn = document.getElementById('forwardIcon');
      const refreshBtn = document.getElementById('refreshIcon');
      const fullscreenBtn = document.getElementById('fullscreenIcon');

      if (backBtn) backBtn.addEventListener('click', e => { 
        e.preventDefault(); 
        if (backBtn.classList.contains('disabled')) return;
        
        // Add click animation and show loading
        backBtn.querySelector('i').classList.add('spin');
        setTimeout(() => backBtn.querySelector('i').classList.remove('spin'), 150);
        showLoadingLine();
        
        try {
          iframe.contentWindow.history.back();
        } catch (err) {
          console.log('Cannot access iframe history, using window history');
          window.history.back();
        }
      });
      
      if (forwardBtn) forwardBtn.addEventListener('click', e => { 
        e.preventDefault(); 
        if (forwardBtn.classList.contains('disabled')) return;
        
        // Add click animation and show loading
        forwardBtn.querySelector('i').classList.add('spin');
        setTimeout(() => forwardBtn.querySelector('i').classList.remove('spin'), 150);
        showLoadingLine();
        
        try {
          iframe.contentWindow.history.forward();
        } catch (err) {
          console.log('Cannot access iframe history, using window history');
          window.history.forward();
        }
      });

      // Function to update navigation button states
      function updateNavigationButtons() {
        try {
          // Enable buttons by default since we can't reliably check iframe history
          if (backBtn) backBtn.classList.remove('disabled');
          if (forwardBtn) forwardBtn.classList.remove('disabled');
        } catch (err) {
          // Keep buttons enabled if we can't check
        }
      }

      // Function to update lock icon based on site security
      function updateLockIcon() {
        const lockIcon = document.getElementById('lockIcon');
        if (!lockIcon) return;

        try {
          // Get the current URL from multiple sources
          let currentUrl = '';
          
          // First, try to get URL from the search input (most reliable for user's perspective)
          const searchInput = document.getElementById('searchInputt');
          if (searchInput && searchInput.value.trim()) {
            let inputValue = searchInput.value.trim();
            
            // If it looks like a URL, use it directly
            if (inputValue.startsWith('http://') || inputValue.startsWith('https://')) {
              currentUrl = inputValue;
            } else if (inputValue.includes('.') && !inputValue.includes(' ')) {
              // Looks like a domain, assume https
              currentUrl = 'https://' + inputValue;
            } else {
              // It's a search query, check what search engine we're using
              const defaultEngine = (typeof window.getSavedSettings === 'function' && window.getSavedSettings().defaultEngine) || 
                                   localStorage.getItem('defaultEngine') || 
                                   'https://duckduckgo.com';
              currentUrl = defaultEngine; // Use the search engine's security
            }
          }
          
          // Fallback: try to decode from iframe src if no search input
          if (!currentUrl && iframe.src) {
            if (iframe.src.includes(window.__uv$config?.prefix)) {
              try {
                const encodedUrl = iframe.src.replace(window.__uv$config.prefix, '');
                if (window.__uv$config.decodeUrl) {
                  currentUrl = window.__uv$config.decodeUrl(encodedUrl);
                } else {
                  // Manual decode attempt
                  currentUrl = decodeURIComponent(encodedUrl);
                }
              } catch (e) {
                console.log('Could not decode proxy URL:', e);
                currentUrl = iframe.src;
              }
            } else {
              currentUrl = iframe.src;
            }
          }

          // Final fallback: use the original URL from page params
          if (!currentUrl) {
            const params = new URLSearchParams(window.location.search);
            const userInput = params.get('url');
            if (userInput) {
              currentUrl = decodeURIComponent(userInput);
            }
          }

          console.log('Lock icon checking URL:', currentUrl); // Debug log

          // Check if URL is secure (HTTPS)
          const isSecure = currentUrl.startsWith('https://');
          const isInsecure = currentUrl.startsWith('http://');
          
          // Update lock icon
          if (isSecure) {
            lockIcon.className = 'fa-solid fa-lock'; // Closed lock for secure
            lockIcon.style.color = '#4ade80'; // Green for secure
            lockIcon.title = 'Secure connection (HTTPS)';
          } else if (isInsecure) {
            lockIcon.className = 'fa-solid fa-lock-open'; // Open lock for insecure
            lockIcon.style.color = '#f87171'; // Red for insecure
            lockIcon.title = 'Insecure connection (HTTP)';
          } else {
            lockIcon.className = 'fa-solid fa-lock'; // Default closed lock
            lockIcon.style.color = '#b9b9b9'; // Gray for unknown/local
            lockIcon.title = 'Connection status unknown';
          }
        } catch (err) {
          console.log('Could not update lock icon:', err);
          // Default to closed lock with gray color
          const lockIcon = document.getElementById('lockIcon');
          if (lockIcon) {
            lockIcon.className = 'fa-solid fa-lock';
            lockIcon.style.color = '#b9b9b9';
            lockIcon.title = 'Connection status unknown';
          }
        }
      }

      // Show loading line when iframe starts loading
      iframe.addEventListener('loadstart', () => {
        showLoadingLine();
      });
      
      // Hide loading line when iframe finishes loading
      iframe.addEventListener('load', () => {
        updateNavigationButtons();
        updateLockIcon();
        hideLoadingLine();
      });
      
      // Update lock icon immediately when page loads
      updateLockIcon();
      
      // Global keyboard shortcuts
      document.addEventListener('keydown', function(e) {
        // Ctrl+E to focus search bar (handle both lowercase and uppercase)
        if (e.ctrlKey && (e.key === 'e' || e.key === 'E')) {
          e.preventDefault();
          // Try to focus the main search input first
          const searchInput = document.getElementById('searchInputt');
          const uvAddress = document.getElementById('uv-address');
          
          if (searchInput) {
            searchInput.focus();
            searchInput.select(); // Select all text for easy replacement
          } else if (uvAddress) {
            uvAddress.focus();
            uvAddress.select(); // Select all text for easy replacement
          }
        }
      });
      
      // Handle loading errors
      iframe.addEventListener('error', () => {
        hideLoadingLine();
      });

      // Also update lock icon when URL changes in search bar
      const searchInputForLock = document.getElementById('searchInputt');
      if (searchInputForLock) {
        searchInputForLock.addEventListener('input', () => {
          updateLockIcon(); // Update immediately as user types
        });
        searchInputForLock.addEventListener('blur', () => {
          updateLockIcon(); // Update when user finishes editing
        });
        searchInputForLock.addEventListener('focus', () => {
          updateLockIcon(); // Update when user focuses on input
        });
      }
      if (refreshBtn) refreshBtn.addEventListener('click', e => { 
        e.preventDefault(); 
        // Add spin animation and show loading
        refreshBtn.querySelector('i').classList.add('spin');
        setTimeout(() => refreshBtn.querySelector('i').classList.remove('spin'), 150);
        showLoadingLine();
        // Refresh iframe
        iframe.src = iframe.src; 
      });
      if (fullscreenBtn) fullscreenBtn.addEventListener('click', e => {
        e.preventDefault();
        if (iframe.requestFullscreen) iframe.requestFullscreen();
      });

      // Search Suggestions System
      class SearchSuggestions {
        constructor(inputElement, containerElement) {
          this.input = inputElement;
          this.container = containerElement;
          this.suggestions = [];
          this.selectedIndex = -1;
          this.isVisible = false;
          
          this.init();
        }
        
        init() {
          this.input.addEventListener('input', (e) => this.handleInput(e));
          this.input.addEventListener('keydown', (e) => this.handleKeydown(e));
          this.input.addEventListener('focus', (e) => this.handleFocus(e));
          this.input.addEventListener('blur', (e) => this.handleBlur(e));
          
          // Close suggestions when clicking outside
          document.addEventListener('click', (e) => {
            if (!this.input.contains(e.target) && !this.container.contains(e.target)) {
              this.hideSuggestions();
            }
          });
        }
        
        async handleInput(e) {
          const query = e.target.value.trim();
          
          if (query.length === 0) {
            this.hideSuggestions();
            return;
          }
          
          if (query.length >= 1) {
            const suggestions = await this.generateSuggestions(query);
            this.showSuggestions(suggestions);
          }
        }
        
        handleFocus(e) {
          const query = e.target.value.trim();
          if (query.length >= 1) {
            this.generateSuggestions(query).then(suggestions => {
              this.showSuggestions(suggestions);
            });
          }
        }
        
        handleBlur(e) {
          // Delay hiding to allow clicking on suggestions
          setTimeout(() => {
            if (!this.container.matches(':hover')) {
              this.hideSuggestions();
            }
          }, 150);
        }
        
        handleKeydown(e) {
          if (!this.isVisible) return;
          
          switch (e.key) {
            case 'ArrowDown':
              e.preventDefault();
              this.selectedIndex = Math.min(this.selectedIndex + 1, this.suggestions.length - 1);
              this.updateSelection();
              break;
              
            case 'ArrowUp':
              e.preventDefault();
              this.selectedIndex = Math.max(this.selectedIndex - 1, -1);
              this.updateSelection();
              break;
              
            case 'Enter':
              if (this.selectedIndex >= 0) {
                e.preventDefault();
                e.stopPropagation();
                this.selectSuggestion(this.suggestions[this.selectedIndex]);
              }
              break;
              
            case 'Escape':
              e.preventDefault();
              this.hideSuggestions();
              break;
          }
        }
        
        async generateSuggestions(query) {
          const suggestions = [];
          const lowerQuery = query.toLowerCase();
          
          // Check if it looks like a URL or domain
          const isUrl = /^https?:\/\//.test(query);
          const isDomain = /^[a-zA-Z0-9][a-zA-Z0-9-]*[a-zA-Z0-9]*\.([a-zA-Z]{2,}|[a-zA-Z]{2,}\.[a-zA-Z]{2,})/.test(query);
          
          if (isUrl) {
            // If it's already a URL, suggest the URL itself
            suggestions.push({
              title: query,
              url: query,
              type: 'url',
              icon: 'fa-solid fa-link'
            });
          } else if (isDomain) {
            // If it looks like a domain, suggest common paths
            const domain = query.includes('/') ? query.split('/')[0] : query;
            const baseDomain = domain.startsWith('www.') ? domain : `www.${domain}`;
            
            suggestions.push({
              title: `https://${baseDomain}`,
              url: `https://${baseDomain}`,
              type: 'website',
              icon: 'fa-solid fa-globe'
            });
            
            // Add common subpaths for popular domains
            const commonPaths = this.getCommonPaths(domain);
            commonPaths.forEach(path => {
              suggestions.push({
                title: `${domain}${path.path}`,
                url: `https://${baseDomain}${path.path}`,
                type: path.type,
                icon: path.icon
              });
            });
          } else {
            // Generate search suggestions for different engines
            const searchEngines = [
              { name: 'DuckDuckGo', url: 'https://duckduckgo.com/?q=', icon: 'fa-solid fa-search' },
              { name: 'Google', url: 'https://www.google.com/search?q=', icon: 'fa-brands fa-google' },
              { name: 'Bing', url: 'https://www.bing.com/search?q=', icon: 'fa-brands fa-microsoft' },
              { name: 'YouTube', url: 'https://www.youtube.com/results?search_query=', icon: 'fa-brands fa-youtube' }
            ];
            
            searchEngines.forEach(engine => {
              suggestions.push({
                title: `Search "${query}" on ${engine.name}`,
                url: engine.url + encodeURIComponent(query),
                type: 'search',
                icon: engine.icon
              });
            });
            
            // Add popular website suggestions based on query
            const websiteSuggestions = this.getWebsiteSuggestions(lowerQuery);
            suggestions.push(...websiteSuggestions);
          }
          
          return suggestions.slice(0, 8); // Limit to 8 suggestions
        }
        
        getCommonPaths(domain) {
          const paths = [];
          const lowerDomain = domain.toLowerCase();
          
          // Gaming sites
          if (lowerDomain.includes('y8')) {
            paths.push(
              { path: '/games', type: 'games', icon: 'fa-solid fa-gamepad' },
              { path: '/apps', type: 'apps', icon: 'fa-solid fa-mobile-screen' },
              { path: '/multiplayer', type: 'multiplayer', icon: 'fa-solid fa-users' }
            );
          } else if (lowerDomain.includes('coolmath')) {
            paths.push(
              { path: '/games', type: 'games', icon: 'fa-solid fa-gamepad' },
              { path: '/0-papas-games', type: 'games', icon: 'fa-solid fa-pizza-slice' },
              { path: '/0-skill-games', type: 'games', icon: 'fa-solid fa-target' }
            );
          } else if (lowerDomain.includes('github')) {
            paths.push(
              { path: '/trending', type: 'trending', icon: 'fa-solid fa-fire' },
              { path: '/explore', type: 'explore', icon: 'fa-solid fa-compass' },
              { path: '/marketplace', type: 'marketplace', icon: 'fa-solid fa-store' }
            );
          } else if (lowerDomain.includes('youtube')) {
            paths.push(
              { path: '/trending', type: 'trending', icon: 'fa-solid fa-fire' },
              { path: '/gaming', type: 'gaming', icon: 'fa-solid fa-gamepad' },
              { path: '/music', type: 'music', icon: 'fa-solid fa-music' }
            );
          } else if (lowerDomain.includes('reddit')) {
            paths.push(
              { path: '/r/popular', type: 'popular', icon: 'fa-solid fa-fire' },
              { path: '/r/all', type: 'all', icon: 'fa-solid fa-globe' },
              { path: '/r/gaming', type: 'gaming', icon: 'fa-solid fa-gamepad' }
            );
          } else {
            // Generic common paths
            paths.push(
              { path: '/about', type: 'about', icon: 'fa-solid fa-info-circle' },
              { path: '/contact', type: 'contact', icon: 'fa-solid fa-envelope' },
              { path: '/help', type: 'help', icon: 'fa-solid fa-question-circle' }
            );
          }
          
          return paths;
        }
        
        getWebsiteSuggestions(query) {
          const suggestions = [];
          const websites = [
            // Gaming
            { keywords: ['game', 'games', 'play', 'gaming'], title: 'Y8 Games', url: 'https://www.y8.com/games', icon: 'fa-solid fa-gamepad' },
            { keywords: ['math', 'cool', 'coolmath'], title: 'Cool Math Games', url: 'https://www.coolmathgames.com', icon: 'fa-solid fa-calculator' },
            { keywords: ['scratch', 'programming'], title: 'Scratch', url: 'https://scratch.mit.edu', icon: 'fa-solid fa-code' },
            
            // Social/Entertainment
            { keywords: ['video', 'youtube', 'watch'], title: 'YouTube', url: 'https://www.youtube.com', icon: 'fa-brands fa-youtube' },
            { keywords: ['reddit', 'forum'], title: 'Reddit', url: 'https://www.reddit.com', icon: 'fa-brands fa-reddit' },
            { keywords: ['twitter', 'tweet'], title: 'Twitter', url: 'https://www.twitter.com', icon: 'fa-brands fa-twitter' },
            
            // Development
            { keywords: ['github', 'git', 'code', 'repository'], title: 'GitHub', url: 'https://www.github.com', icon: 'fa-brands fa-github' },
            { keywords: ['stack', 'overflow', 'programming'], title: 'Stack Overflow', url: 'https://stackoverflow.com', icon: 'fa-brands fa-stack-overflow' },
            
            // Education
            { keywords: ['wiki', 'wikipedia', 'encyclopedia'], title: 'Wikipedia', url: 'https://www.wikipedia.org', icon: 'fa-brands fa-wikipedia-w' },
            { keywords: ['khan', 'academy', 'learn'], title: 'Khan Academy', url: 'https://www.khanacademy.org', icon: 'fa-solid fa-graduation-cap' }
          ];
          
          websites.forEach(site => {
            if (site.keywords.some(keyword => query.includes(keyword))) {
              suggestions.push({
                title: site.title,
                url: site.url,
                type: 'website',
                icon: site.icon
              });
            }
          });
          
          return suggestions;
        }
        
        showSuggestions(suggestions) {
          this.suggestions = suggestions;
          this.selectedIndex = -1;
          
          if (suggestions.length === 0) {
            this.hideSuggestions();
            return;
          }
          
          this.container.innerHTML = '';
          
          suggestions.forEach((suggestion, index) => {
            const item = document.createElement('div');
            item.className = 'suggestion-item';
            item.innerHTML = `
              <i class="suggestion-icon ${suggestion.icon}"></i>
              <div class="suggestion-content">
                <div class="suggestion-title">${this.escapeHtml(suggestion.title)}</div>
                <div class="suggestion-url">${this.escapeHtml(suggestion.url)}</div>
              </div>
              <div class="suggestion-type">${suggestion.type}</div>
            `;
            
            item.addEventListener('click', () => {
              this.selectSuggestion(suggestion);
            });
            
            this.container.appendChild(item);
          });
          
          this.container.style.display = 'block';
          this.isVisible = true;
        }
        
        hideSuggestions() {
          this.container.style.display = 'none';
          this.isVisible = false;
          this.selectedIndex = -1;
        }
        
        updateSelection() {
          const items = this.container.querySelectorAll('.suggestion-item');
          items.forEach((item, index) => {
            item.classList.toggle('selected', index === this.selectedIndex);
          });
          
          // Update input value with selected suggestion
          if (this.selectedIndex >= 0) {
            const selectedSuggestion = this.suggestions[this.selectedIndex];
            // Don't update input value to avoid interfering with typing
          }
        }
        
        selectSuggestion(suggestion) {
          this.input.value = suggestion.url;
          this.hideSuggestions();
          
          // Store the URL and navigate
          localStorage.setItem('lastUvUrl', suggestion.url);
          
          // Show loading line before navigation
          const loadingLine = document.getElementById('loadingLine');
          if (loadingLine) {
            loadingLine.style.display = 'block';
            loadingLine.classList.remove('hide');
            const progressBar = loadingLine.querySelector('.progress-bar');
            if (progressBar) {
              progressBar.style.width = '0%';
              progressBar.style.animation = 'loadingProgress 3s ease-out forwards, shimmer 1.1s ease-in-out infinite';
            }
          }
          
          // Navigate to the selected URL
          window.location.href = '/active/search.html?url=' + encodeURIComponent(suggestion.url);
        }
        
        escapeHtml(text) {
          const div = document.createElement('div');
          div.textContent = text;
          return div.innerHTML;
        }
      }

      // small search bar (top navbar) behavior
      const searchInput = document.getElementById('searchInputt');
      if (searchInput) {
        const lastUvUrl = localStorage.getItem('lastUvUrl');
        if (lastUvUrl) searchInput.value = lastUvUrl;
        
        // Initialize search suggestions
        const suggestionsContainer = document.getElementById('suggestions-container');
        if (suggestionsContainer) {
          new SearchSuggestions(searchInput, suggestionsContainer);
        }

        searchInput.addEventListener('keydown', function(e) {
          // Let the suggestions system handle Enter key if suggestions are visible
          const suggestionsContainer = document.getElementById('suggestions-container');
          const suggestionsVisible = suggestionsContainer && suggestionsContainer.style.display === 'block';
          
          if (e.key === "Enter" && !suggestionsVisible) {
            e.preventDefault();
            const newVal = searchInput.value.trim();
            if (!newVal) return;
            localStorage.setItem('lastUvUrl', newVal);

            let url;
            try { url = new URL(newVal).toString(); }
            catch { url = `https://duckduckgo.com/?q=${encodeURIComponent(newVal)}`; }

            // Update lock icon before navigation
            updateLockIcon();
            
            // Show loading line before navigation
            showLoadingLine();
            
            // navigate to same page with proper query param (will be normalized by this script)
            window.location.href = '/active/search.html?url=' + encodeURIComponent(url);
          }
        });
      }

            // small search bar (top navbar) behavior - alternative input handling
      const uvaddress = document.getElementById('uv-address');
      if (uvaddress) {
        const lastUvUrl = localStorage.getItem('lastUvUrl');
        if (lastUvUrl) uvaddress.value = lastUvUrl;

        uvaddress.addEventListener('keydown', function(e) {
          if (e.key === "Enter") {
            e.preventDefault();
            const newVal = uvaddress.value.trim();
            if (!newVal) return;
            localStorage.setItem('lastUvUrl', newVal);

            let url;
            try { url = new URL(newVal).toString(); }
            catch { url = `https://duckduckgo.com/?q=${encodeURIComponent(newVal)}`; }

            // Show loading line before navigation
            showLoadingLine();
            
            // navigate to same page with proper query param (will be normalized by this script)
            window.location.href = '/active/search.html?url=' + encodeURIComponent(url);
          }
        });
      }

      // Navbar shrink on iframe scroll (supports Ultraviolet proxied pages)
      document.addEventListener('DOMContentLoaded', () => {
        const iframeEl = document.getElementById('cool-iframe');
        const navbar = document.querySelector('.navbar');
        if (!iframeEl || !navbar) return;

        // Add CSS for compact, URL-only rounded mode
        const styleEl = document.createElement('style');
        styleEl.textContent = `
          .navbar { transition: padding 0.2s ease, height 0.2s ease, transform 0.2s ease, top 0.2s ease, background-color 0.2s ease; }
          .navbar.navbar-collapsed { background: transparent !important; padding: 6px 0 !important; height: auto; top: 8px !important; }
          .navbar.navbar-collapsed .navbar-light,
          .navbar.navbar-collapsed .navbar-light-border,
          .navbar.navbar-collapsed .navbar-light-inset-bg { display: none !important; }
          .navbar.navbar-collapsed .nav-buttons > li { display: none !important; }
          .navbar.navbar-collapsed .nav-buttons > li.url-item { display: flex !important; }
          .navbar .nav-buttons { justify-content: center; }
          .navbar.navbar-collapsed .small-searchbar { 
            width: 560px; max-width: 90vw;
            background-color: rgba(0,0,0,0.6);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 999px; padding: 6px 12px; position: relative;
            box-shadow: 0 4px 14px rgba(0,0,0,0.35);
          }
          .navbar.navbar-collapsed .small-searchbar input[type=text] {
            width: 100%; background: transparent; border: none; color: #e5e5e5;
            padding: 10px 16px 10px 40px; /* leave space for lock icon */
          }
          .navbar.navbar-collapsed #lockIcon { left: 18px; color: #b9b9b9; }
          .navbar.navbar-collapsed .shortcut-indicator,
          .navbar.navbar-collapsed .shortcut-indicator-2,
          .navbar.navbar-collapsed .shortcut-indicator-3 { display: none !important; }
        `;
        document.head.appendChild(styleEl);

        // Mark the URL bar's list item for targeting in collapsed mode
        const urlBarLi = document.querySelector('.small-searchbar')?.closest('li');
        if (urlBarLi) urlBarLi.classList.add('url-item');

        let isShrunk = false;
        function setShrink(shrink) {
          if (shrink === isShrunk) return;
          isShrunk = shrink;
          navbar.classList.toggle('navbar-collapsed', shrink);
        }

        function attachIframeScrollHandlers() {
          try {
            const cw = iframeEl.contentWindow;
            if (!cw) return;

            // Track scroll direction inside the iframe's document
            let lastY = cw.scrollY || 0;
            cw.addEventListener('scroll', () => {
              const y = cw.scrollY || 0;
              if (y > lastY + 1) setShrink(true);
              else if (y < lastY - 1) setShrink(false);
              lastY = y;
            }, { passive: true });

            // Also handle wheel direction for immediate feedback
            cw.addEventListener('wheel', (e) => {
              if (e.deltaY > 0) setShrink(true);
              else if (e.deltaY < 0) setShrink(false);
            }, { passive: true });
          } catch (e) {
            // If cross-origin blocks access, fallback to wheel over the iframe element (limited)
            iframeEl.addEventListener('wheel', (e) => {
              if (e.deltaY > 0) setShrink(true);
              else if (e.deltaY < 0) setShrink(false);
            }, { passive: true });
          }
        }

        // Attach now if already loaded; otherwise on load
        if (iframeEl.complete) {
          attachIframeScrollHandlers();
        }
        iframeEl.addEventListener('load', attachIframeScrollHandlers);
      });

      // eruda init (do not attach to iframe)
      if (typeof eruda !== 'undefined') {
        try { eruda.init(); } catch (e) { /* ignore eruda attach errors */ }
      }

      // Light following effect for navbar
      const navbar = document.querySelector('.navbar');
      const navbarLightBg = navbar.querySelector('.navbar-light');
      const navbarLightBorder = navbar.querySelector('.navbar-light-border');
      const lightSize = 300;

      let navbarTargetX = 0, navbarTargetY = 0;
      let navbarCurrentX = 0, navbarCurrentY = 0;
      let navbarLastX = 0, navbarLastY = 0;
      let navbarVelocityX = 0, navbarVelocityY = 0;
      let navbarRaf;

      function navbarAnimate() {
        navbarCurrentX += (navbarTargetX - navbarCurrentX) * 0.15;
        navbarCurrentY += (navbarTargetY - navbarCurrentY) * 0.15;

        const elasticX = Math.min(Math.max(navbarVelocityX * 0.5, -20), 20);
        const elasticY = Math.min(Math.max(navbarVelocityY * 0.5, -20), 20);

        const bgX = `${navbarCurrentX - lightSize / 2 + elasticX}px`;
        const bgY = `${navbarCurrentY - lightSize / 2 + elasticY}px`;

        navbarLightBg.style.setProperty('--navbar-bg-x', bgX);
        navbarLightBg.style.setProperty('--navbar-bg-y', bgY);
        navbarLightBorder.style.setProperty('--navbar-bg-x', bgX);
        navbarLightBorder.style.setProperty('--navbar-bg-y', bgY);

        navbarRaf = requestAnimationFrame(navbarAnimate);
      }

      navbar.addEventListener('mouseenter', () => {
        cancelAnimationFrame(navbarRaf);
        navbarRaf = requestAnimationFrame(navbarAnimate);

        navbarLightBg.style.opacity = 1;
        navbarLightBorder.style.opacity = 1;
        navbarLightBg.style.transition = "opacity 0.4s ease, transform 0.4s ease, filter 0.6s ease";
        navbarLightBorder.style.transition = "opacity 0.4s ease, transform 0.4s ease, filter 0.6s ease";

        navbarLightBg.style.transform = "scale(1.15)";
        navbarLightBg.style.filter = "blur(20px)";
        navbarLightBorder.style.transform = "scale(1.1)";
        navbarLightBorder.style.filter = "blur(6px)";

        setTimeout(() => {
          navbarLightBg.style.transform = "scale(1)";
          navbarLightBg.style.filter = "blur(12px)";
          navbarLightBorder.style.transform = "scale(1)";
          navbarLightBorder.style.filter = "blur(4px)";
        }, 300);
      });

      navbar.addEventListener('mouseleave', () => {
        cancelAnimationFrame(navbarRaf);

        navbarLightBg.style.transition = "opacity 0.6s ease, transform 0.6s ease, filter 0.6s ease";
        navbarLightBorder.style.transition = "opacity 0.6s ease, transform 0.6s ease, filter 0.6s ease";

        navbarLightBg.style.opacity = 0;
        navbarLightBorder.style.opacity = 0;
        navbarLightBg.style.transform = "scale(0.95)";
        navbarLightBorder.style.transform = "scale(0.95)";
        navbarLightBg.style.filter = "blur(30px)";
        navbarLightBorder.style.filter = "blur(12px)";
      });

      navbar.addEventListener('mousemove', (e) => {
        const rect = navbar.getBoundingClientRect();
        navbarTargetX = e.clientX - rect.left;
        navbarTargetY = e.clientY - rect.top;

        navbarVelocityX = navbarTargetX - navbarLastX;
        navbarVelocityY = navbarTargetY - navbarLastY;
        navbarLastX = navbarTargetX;
        navbarLastY = navbarTargetY;

        const glowStrength = Math.min(1.2, 0.8 + navbarTargetX / rect.width * 0.4);
        navbarLightBg.style.transform = `scale(${glowStrength})`;
      });
    });
    </script>

    <!-- optionally load eruda; safe init is handled above -->
    <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
  </body>
</html>
